{
    "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
        "newStorageAccountName":{
            "type":"string",
            "metadata":{
                "description":"Unique DNS Name for the Storage Account where the Virtual Machine's disks will be placed."
            }
        },
        "adminUsername":{
            "type":"string",
            "defaultValue":"test-user",
            "metadata":{
                "description":"User name for the Virtual Machine."
            }
        },
        "adminPassword":{
            "type":"string",
            "metadata":{
                "description":"Password for the Virtual Machine."
            }
        },
        "dnsNameForPublicIP":{
            "type":"string",
            "metadata":{
                "description":"Unique DNS Name for the Public IP used to accessthe Virtual Machine."
            }
        },
        "slaveCount":{
            "type":"int",
            "defaultValue":1,
            "metadata":{
                "description":"Number of slave nodes."
            }
        }
    },
    "variables":{
        "vmNameMaster":"swarm-master",
        "vmSizeMaster":"Standard_A0",
        "availabilitySetMaster":"swarm-master-set",
        "availabilitySetSlaves":"swarm-nodes-set",
        "osImagePublisher":"CoreOS",
        "osImageOffer":"CoreOS",
        "osImageSKU":"Stable",
        "masterPublicIPAddrName":"swarm-masters-ip",
        "virtualNetworkName":"swarm-vnet",
        "subnetNameMaster":"subnet-master",
        "addressPrefixMaster":"10.0.0.0/16",
        "subnetPrefixMaster":"10.0.0.0/24",
        "subnetNameSlave":"subnet-slave",
        "addressPrefixSlave":"192.168.0.0/16",
        "subnetPrefixSlave":"192.168.0.0/24",
        "subnetRefMaster":"[concat(resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName')),'/subnets/',variables('subnetNameMaster'))]",
        "nsgName":"swarm-nsg",
        "nsgID":"[resourceId('Microsoft.Network/networkSecurityGroups',variables('nsgName'))]",
        "storageAccountType":"Standard_LRS",
        "vhdBlobContainer":"vhds",
        "subnetRefSlave":"[concat(resourceId(resourceGroup().name,'Microsoft.Network/virtualNetworks',variables('virtualNetworkName')),'/subnets/',variables('subnetNameSlave'))]",
        "sshKeyPath":"[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]"
    },
    "resources":[
        {
            "type":"Microsoft.Storage/storageAccounts",
            "name":"[parameters('newStorageAccountName')]",
            "apiVersion":"2015-05-01-preview",
            "location":"[resourceGroup().location]",
            "properties":{
                "accountType":"[variables('storageAccountType')]"
            }
        },
        {
            "type":"Microsoft.Compute/availabilitySets",
            "name":"[variables('availabilitySetMaster')]",
            "apiVersion":"2015-05-01-preview",
            "location":"[resourceGroup().location]",
            "properties":{

            }
        },
        {
            "type":"Microsoft.Compute/availabilitySets",
            "name":"[variables('availabilitySetSlaves')]",
            "apiVersion":"2015-05-01-preview",
            "location":"[resourceGroup().location]",
            "properties":{

            }
        },
        {
            "apiVersion":"2015-05-01-preview",
            "type":"Microsoft.Network/publicIPAddresses",
            "name":"[variables('masterPublicIPAddrName')]",
            "location":"[resourceGroup().location]",
            "properties":{
                "publicIPAllocationMethod":"Dynamic",
                "dnsSettings":{
                    "domainNameLabel":"[concat(parameters('dnsNameForPublicIP'), '-master')]"
                }
            }
        },
        {
            "apiVersion":"2015-05-01-preview",
            "type":"Microsoft.Network/virtualNetworks",
            "name":"[variables('virtualNetworkName')]",
            "location":"[resourceGroup().location]",
            "dependsOn":[
                "[variables('nsgID')]"
            ],
            "properties":{
                "addressSpace":{
                    "addressPrefixes":[
                        "[variables('addressPrefixMaster')]",
                        "[variables('addressPrefixSlave')]"
                    ]
                },
                "subnets":[
                    {
                        "name":"[variables('subnetNameMaster')]",
                        "properties":{
                            "addressPrefix":"[variables('subnetPrefixMaster')]",
                            "networkSecurityGroup":{
                                "id":"[variables('nsgID')]"
                            }
                        }
                    },
                    {
                        "name":"[variables('subnetNameSlave')]",
                        "properties":{
                            "addressPrefix":"[variables('subnetPrefixSlave')]",
                            "networkSecurityGroup":{
                                "id":"[variables('nsgID')]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "apiVersion":"2015-05-01-preview",
            "type":"Microsoft.Network/networkSecurityGroups",
            "name":"[variables('nsgName')]",
            "location":"[resourceGroup().location]",
            "properties":{
                "securityRules":[
                    {
                        "name":"ssh",
                        "properties":{
                            "description":"SSH",
                            "protocol":"Tcp",
                            "sourcePortRange":"*",
                            "destinationPortRange":"22",
                            "sourceAddressPrefix":"*",
                            "destinationAddressPrefix":"*",
                            "access":"Allow",
                            "priority":200,
                            "direction":"Inbound"
                        }
                    }
                ]
            }
        },
        {
            "apiVersion":"2015-05-01-preview",
            "type":"Microsoft.Network/networkInterfaces",
            "name":"[concat(variables('vmNameMaster'),'-nic')]",
            "location":"[resourceGroup().location]",
            "dependsOn":[
                "[concat('Microsoft.Network/publicIPAddresses/',variables('masterPublicIPAddrName'))]",
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]"
            ],
            "properties":{
                "ipConfigurations":[
                    {
                        "name":"ipConfigMaster",
                        "properties":{
                            "privateIPAllocationMethod":"Dynamic",
                            "publicIPAddress":{
                                "id":"[resourceId('Microsoft.Network/publicIPAddresses',variables('masterPublicIPAddrName'))]"
                            },
                            "subnet":{
                                "id":"[variables('subnetRefMaster')]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "apiVersion":"2015-05-01-preview",
            "type":"Microsoft.Compute/virtualMachines",
            "name":"[concat(variables('vmNameMaster'))]",
            "location":"[resourceGroup().location]",
            "dependsOn":[
                "[concat('Microsoft.Storage/storageAccounts/', parameters('newStorageAccountName'))]",
                "[concat('Microsoft.Network/networkInterfaces/', variables('vmNameMaster'), '-nic')]",
                "[concat('Microsoft.Compute/availabilitySets/', variables('availabilitySetMaster'))]"
            ],
            "properties":{
                "availabilitySet":{
                    "id":"[resourceId('Microsoft.Compute/availabilitySets',variables('availabilitySetMaster'))]"
                },
                "hardwareProfile":{
                    "vmSize":"[variables('vmSizeMaster')]"
                },
                "osProfile":{
                    "computername":"[variables('vmNameMaster')]",
                    "adminUsername":"[parameters('adminUsername')]",
                    "adminPassword":"[parameters('adminPassword')]"
                },
                "storageProfile":{
                    "imageReference":{
                        "publisher":"[variables('osImagePublisher')]",
                        "offer":"[variables('osImageOffer')]",
                        "sku":"[variables('osImageSKU')]",
                        "version":"latest"
                    },
                    "osDisk":{
                        "name":"[concat(variables('vmNameMaster'),'-osdisk')]",
                        "vhd":{
                            "uri":"[concat('http://', parameters('newStorageAccountName'), '.blob.core.windows.net/', variables('vhdBlobContainer'), '/master-osdisk.vhd')]"
                        },
                        "caching":"ReadWrite",
                        "createOption":"FromImage"
                    }
                },
                "networkProfile":{
                    "networkInterfaces":[
                        {
                            "id":"[resourceId('Microsoft.Network/networkInterfaces',concat(variables('vmNameMaster'),'-nic'))]"
                        }
                    ]
                }
            }
        },
        {
            "type":"Microsoft.Compute/virtualMachines/extensions",
            "name":"[concat(variables('vmNameMaster'), '/CustomScriptExtension')]",
            "apiVersion":"2015-05-01-preview",
            "location":"[resourceGroup().location]",
            "dependsOn":[
                "[concat('Microsoft.Compute/virtualMachines/', variables('vmNameMaster'))]",
                "SwarmSlaveNodes"
            ],
            "properties":{
                    "publisher": "Microsoft.OSTCExtensions",
    		        "type": "CustomScriptForLinux",
    		        "typeHandlerVersion": "1.3",
    		        "settings": {
    		            "commandToExecute": "[parameters('command')]"
    		        }
            }
        },
        {
            "name":"SwarmSlaveNodes",
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"2015-01-01",
            "dependsOn":[
                "[concat('Microsoft.Storage/storageAccounts/', parameters('newStorageAccountName'))]",
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]"
            ],
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri":"https://raw.githubusercontent.com/garimakhulbe/Project/master/arm-templates/SwarmSlavesDeployment.json",
                    "contentVersion":"1.0.0.0"
                },
                "parameters":{
                    "newStorageAccountName":{
                        "value":"[parameters('newStorageAccountName')]"
                    },
                    "adminUsername":{
                        "value":"[parameters('adminUserName')]"
                    },
                    "adminPassword":{
                        "value":"[parameters('adminPassword')]"
                    },
                    "dnsNameForPublicIP":{
                        "value":"[parameters('dnsNameForPublicIP')]"
                    },
                    "slaveCount":{
                        "value":"[parameters('slaveCount')]"
                    },
                    "command":{
                        "value":"[parameters('command')]"
                    }
                }
            }
        }
    ],
    "outputs":{
        "SwarmManagerHostName":{
            "type":"string",
            "value":"[reference(variables('masterPublicIPAddrName')).dnsSettings.fqdn]"
        },
        "SwarmManagerPort":{
            "type":"string",
            "value":"2376"
        }
    }
}
