{
    	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    	"contentVersion": "1.0.0.0",
    	"parameters" : {
      		"newStorageAccountName": {
			"type": "string",
			"metadata": {
				"description": "Unique DNS Name for the Storage Account where the Virtual Machine's disks will be placed."
			}
		},
		"adminUsername": {
			"type": "string",
			"defaultValue" : "test-user",
			"metadata": {
				"description": "user name for the Virtual Machine."
			}
		},
		"adminPassword": {
			"type": "string",
			"defaultValue" : "Abcd1234@",
			"metadata": {
				"description": "Password for the Virtual Machine."
			}
		},
		"dnsNameForPublicIP": {
			"type": "string",
			"metadata": {
				"description": "Unique DNS Name for the Public IP used to accessthe Virtual Machine."
			}
		},
		"slaveCount": {
			"type": "int",
			"defaultValue": 1,
			"metadata": {
				"description": "Number of slave nodes"
			}
		},
		"swarmClusterId": {
			"type": "string",
			"metadata": {
				"description": "Swarm cluster id"
			}
		},
		"nodeCount":{
			"type": "Int",
			"defaultValue" : 1,
			"metadata": {
				"description": "Node count for autoscale"
			}
		},
		"upperThresholdForCPUUsage":{
			"type": "Int",
			"defaultValue" : 80,
			"metadata": {
				"description": "Upper threshold of the CPU usage for autoscaling"
			}
		},
		"clientId":{
			"type": "string",
			"defaultValue" : "619523f4-e9b7-4234-adae-a868b1ce6870",
			"metadata": {
				"description": "Client Id"
			}
		},
		"clientSecret":{
			"type": "string",
			"defaultValue" : "Abcd1234@",
			"metadata": {
				"description": "Client secret"
			}
		},
		"subscriptionId":{
			"type": "string",
			"defaultValue" : "5f20c827-31e2-4f17-9127-da8968795689",
			"metadata": {
				"description": "Subscription id"
			}
		},
		"tenantId":{
			"type": "string",
			"metadata": {
				"description": "Tenant id"
			}
		},
		"storageAccount":{
			"type": "string",
			"defaultValue" : "testintern5",
			"metadata": {
				"description": "Storage Account to store CPU usage"
			}
		},
		"storageKey":{
			"type": "string",
			"defaultValue" : "OfYZjvjUBhrPtLV6RQiJBCZPtwCDsPUvVBb7DTvWRPj80ES7KV0j487maaza9tQhw58na9aWk0/AbcgRnQAgoA==",
			"metadata": {
				"description": "Storage key to access storage account"
			}
		}
		
    },
	"variables": {
		"vmNameSlave": "swarm-node-",
		"vmSizeSlave": "Standard_A2",
		"availabilitySetSlaves": "swarm-nodes-set",
		"osImagePublisher": "CoreOS",
		"osImageOffer": "CoreOS",
		"osImageSKU": "Stable",
		"virtualNetworkName": "swarm-vnet",
		"subnetNameSlave": "subnet-slave",
		"addressPrefixSlave": "192.168.0.0/16",
		"subnetPrefixSlave": "192.168.0.0/24",
		"subnetRefSlave": "[concat(resourceId(resourceId(resourceGroup().name,'Microsoft.Network/virtualNetworks',variables('virtualNetworkName')),'/subnets/',variables('subnetNameSlave'))]",
		"storageAccountType": "Standard_LRS",
		"vhdBlobContainer": "vhds",
		"sshKeyPath": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
  },
  "resources": [
		{
		  "apiVersion": "2015-05-01-preview",
		  "type": "Microsoft.Network/networkInterfaces",
		  "name": "[concat(variables('vmNameSlave'),copyIndex(), '-nic')]",
		  "location": "[variables('location')]",
		  "copy": {
			"name": "nicLoop",
			"count": "[parameters('slaveCount')]"
		  },
		  "properties": {
			"ipConfigurations": [
			  {
				"name": "ipConfigSlave",
					"properties": {
					  "privateIPAllocationMethod": "Dynamic",
					  "subnet": {
						"id": "[variables('subnetRefSlave')]"
					  }
				}
			  }
			]
		  }
		},
		{
		  "apiVersion": "2015-05-01-preview",
		  "type": "Microsoft.Compute/virtualMachines",
		  "name": "[concat(variables('vmNameSlave'), copyIndex())]",
		  "location": "[resourceGroup().location]",
		  "copy": {
			"name": "vmLoopSlave",
			"count": "[parameters('slaveCount')]"
		  },
		  "dependsOn": [
			"[concat('Microsoft.Network/networkInterfaces/', variables('vmNameSlave'), copyIndex(), '-nic')]"
		  ],
		  "properties": {
			"availabilitySet": {
			  "id": "[resourceId(resourceGroup().name,'Microsoft.Compute/availabilitySets',variables('availabilitySetSlaves'))]"
			},
			"hardwareProfile": {
			  "vmSize": "[variables('vmSizeSlave')]"
			},
			"osProfile": {
			  "computername": "[concat(variables('vmNameSlave'), copyIndex())]",
			  "adminUsername": "[parameters('adminUsername')]",
			  "adminPassword": "[parameters('adminPassword')]"
			},
			"storageProfile": {
			  "imageReference": {
				"publisher": "[variables('osImagePublisher')]",
				"offer": "[variables('osImageOffer')]",
				"sku": "[variables('osImageSKU')]",
				"version": "latest"
			  },
			  "osDisk": {
				"name": "[concat(variables('vmNameSlave'), copyIndex(),'-osdisk')]",
				"vhd": {
				  "uri": "[concat('http://', parameters('newStorageAccountName'), '.blob.core.windows.net/', variables('vhdBlobContainer'), '/slave-', copyIndex(), '-osdisk.vhd')]"
				},
				"caching": "ReadWrite",
				"createOption": "FromImage"
			  }
			},
			"networkProfile": {
			  "networkInterfaces": [
				{
				  "id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('vmNameSlave'), copyindex(), '-nic'))]"
				}
			  ]
			}
		  }
		},
		{
		  "type": "Microsoft.Compute/virtualMachines/extensions",
		  "name": "[concat(variables('vmNameMaster'), '/DockerExtension')]",
		  "apiVersion": "2015-05-01-preview",
		  "location": "[resourceGroup().location]",
		  "dependsOn": [
			"[concat('Microsoft.Compute/virtualMachines/', variables('vmNameSlave'), copyIndex())]"
		  ],
		  "properties": {
			"publisher": "Microsoft.Azure.Extensions",
			"type": "DockerExtension",
			"typeHandlerVersion": "1.0",
			"settings": {
				 "docker": {
						"port": "2375"
				},
				"compose": {
					"autoscale":{
						"image": "garima0079/autoscale1",
						"restart": "always",
						"environment":[ "[concat('HOST_VM=',concat(variables('vmName'), copyIndex()))]",
								"[concat('STORAGE_ACCOUNT=',parameters('storageAccount'))]",
								"[concat('STORAGE_KEY=',parameters('storageKey'))]"
							],
						"command": "[concat('client ', resourceGroup().name)]"
					},
					"swarm": {
						"image": "garima0079/swarm",
						"restart": "always",
						"command": "[concat('join --addr=', reference(concat(variables('vmNameSlave'),copyIndex(), '-nic')).ipConfigurations[0].properties.privateIPAddress, ':2375 token://',parameters('swarmClusterId'))]"
					}
				}
			}
		  }
		}
	  ]
	}
